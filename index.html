<!DOCTYPE html>
<html>
<!--
made by yudai takegawa
(c) 2017 all rights reserved

you can:
 - distribute
 - modify
you cannot:
 - commercial use
-->
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Workaholic</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <style>
        body{
            color:#444;
        }
        .hoverer:hover {
            background-color: #eee;
            color: #000;
            cursor: pointer;
        }
        .addEdit {
            background-color: #f5f5f5;
            border-radius: 5px;
            border: 1px solid #eee;
            padding-bottom: 1em;
        }
        .delete{
            width: .8em;
        }
        .delete:hover{
            cursor: pointer;
        }
        #showTerm, #editWorktime{
            top: 10px;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 18px 20px;
            display: inline-block;
            margin-top: 1em;
        }
        #editWorktime .input-group{
            max-width: 300px;
            margin:4px;
        }
        #termBack, #editBack{
            text-align: center;
            top:0;
            left: 0;
            width: 100%;
            height: auto !important;
            min-height: 100%;
            display: none;
            background-color: rgba(255,255,255,.5);
            padding-bottom: 15em
        }
        #termBack{
            z-index: 10;
            position: absolute;
        }
        #editBack{
            z-index: 15;
            position: fixed;
        }
        .block {
            padding: 10px;
            cursor: pointer;
        }
        .block:hover {
            background-color: #eeeeee;
        }
        #shift_table div{
            margin: 3em 0;
            border: 1px solid #eeeeee;
            border-left: 5px solid #1b809e;
            border-radius: 2px;
            padding: 20px
        }
        #shift_table div h4{
            color :#1b809e;
            font-weight: bold;
        }
        #shift_table div p{
            font-size: 2em;
        }
        #success, #error {
            margin-top: 1em;
            padding: 1em;
        }
        #addWorktime{
            margin-bottom: 4em;
        }
        #addWorktime .input-group{
            max-width: 300px;
            margin:4px;
            text-align: right;
        }
        .a{
            max-width: 370px !important;
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="termBack">
            <div id="showTerm"></div>
        </div>
        <div id="editBack">
            <div id="editWorktime"></div>
        </div>
        <h2>Workaholic v1.0</h2>
        <p>textareaにシフト表をコピペしてsubmit。submitしたときに、同時にデータをブラウザに保存します。</p>
        <textarea id="shift_textarea" rows="7" class="form-control" placeholder="シフト表を全選択してコピー&ペースト..."></textarea><br>
        <div>
            <button class="btn btn-default" type="submit" id="shift_submit">勤務時間を追加/上書き</button>
        </div>
        <p id="success" style="display: none" class="bg-success text-success"></p>
        <p id="error" style="display: none" class="bg-danger text-danger"></p>
        <!--insert table here...-->
        <div id="shift_table" style="margin: 3em 0;"></div>
        <div id="addWorktime">
            <button class="btn btn-primary" type="submit" id="add_submit">勤務時間を手動追加</button>
        </div>
        <div class="checkbox">
            <label>
                <input type="checkbox" value="" id="delete_checkbox">
                表のコラムの削除時に警告を表示しない
            </label>
        </div>
        <div class="checkbox" style="margin-bottom: 5em;">
            <label>
                <input type="checkbox" value="" id="delete_day_checkbox">
                勤務時間の削除時に警告を表示しない
            </label>
        </div>
        <div class="json">
            <h4>バックアップ用</h4>
            <p>下のtextareaには上のデータがjson形式で表示されます。これをどこかのファイルで保存・共有しておくと、ブラウザが変わったりデバイスが変わってもデータを引き継ぐことができます。</p>
            <textarea id="json_textarea" rows="7" class="form-control" placeholder="" onclick="this.focus();this.select()" readonly="readonly"></textarea>

            <div class="checkbox">
                <label>
                    <input type="checkbox" value="" id="json_checkbox">
                    JSONを整理して表示
                </label>
            </div>
            <br>
            <textarea id="json_input_textarea" rows="3" class="form-control" placeholder="データが消えたとき用、バックアップのjsonから読み込み..."></textarea><br>
            <div style="margin-bottom: 6em">
                <button class="btn btn-default" type="submit" id="json_submit">Submit</button>
            </div>
        </div>
        <p>powered by <a href="http://getbootstrap.com/">bootstrap</a></p>
    </div> <!-- /container -->

</body>
<script type="text/javascript">

var hhmmformformat = '<div class="input-group"><div class="input-group-addon">開始時刻</div>{0}<div class="input-group-addon">時</div>{1}<div class="input-group-addon">分</div></div><div class="input-group"><div class="input-group-addon">終了時刻</div>{2}<div class="input-group-addon">時</div>{3}<div class="input-group-addon">分</div></div>';

/*
 * 使用するlocalStorage
 *  - data                  :  theYggdrasilをstring化したもの
 *  - json_checkbox         :  チェックボックスがcheckedであるなら1
 *  - delete_checkbox       :  同上
 *  - delete_day_checkbox   :  同上
 *  - bookmarked            :  ブックマークした日付
 */

theYggdrasil = {};
/*
 * theYggdrasil(全部のデータを格納するobj)の構造は
 * 
 * {
 *   - "2017.8.0" : 8月上半期の勤務obj
 *   - "2017.8.1" : 8月下半期の勤務obj
 *   - "2017.9.0" : 9月上半期の勤務obj
 *   - ...
 * }
 */

// 半月の勤務履歴を開いているか否か。
// showingTerm === ($("#showTerm").display === 'none') -> true
showingTerm = false;

showingEdit = false;

// 実行日のdate obj。 
// 年月日だけわかればいいのでHTMLが読まれる段階で作成。
today = new Date();

/*
 * チェックボックスの初期化とイベントハンドラ登録。
 */
function initCheckboxAttr() {
    var checkboxIds = ["json_checkbox", "delete_checkbox", "delete_day_checkbox"];
    for (var boxId of checkboxIds){
        var node = $("#" + boxId);
        var item = localStorage.getItem(boxId);
        if (item === "1"){
            node.checked = true;
        } else {
            node.checked = false;
        }
        // register onchange event handler
        // チェックボックスの値が変化するたびに、チェックボックスをチェックしてデータをlocalStorageに格納。
        node.onchange = function(e){
            var data = e.srcElement.checked ? "1" : "0";
            localStorage.setItem(e.srcElement.id, data);
        }
    }
}

/*
 * bodyが読み込まれたときに発火する関数。
 */
function bodyLoadEvent() {
    initCheckboxAttr();

    $('#termBack').onclick = function(e){
        if (showingTerm){
            hideTerm();
        }
    };

    $('#editBack').onclick = function(e){
        if (showingEdit){
            hideEdit();
        }
    };

    $('#showTerm').onclick = function(e){
        e.stopPropagation();
    };

    $('#editWorktime').onclick = function(e){
        e.stopPropagation();
    };

    // shift_submitエレメントにonclick属性を追加。(イベントハンドラを登録)
    $('#shift_submit').onclick = function(){
        extractData();
    };

    $('#json_submit').onclick = function(){
        theYggdrasil = JSON.parse($('#json_input_textarea').value);
        saveData();
    };

    $('#add_submit').onclick = function(){
        initAddWorktime();
    };

    var local_data = localStorage.getItem("data");
    if (local_data != null) {
        if ($('#json_checkbox').checked){
            $('#json_textarea').value = JSON.stringify(JSON.parse(local_data), null, "    ");
        } else {
            $('#json_textarea').value = local_data;
        }
        theYggdrasil = JSON.parse(local_data);
        buildTableContent();
    }
}

/*
 * ある日の勤務時間objのArrayに、新しい仲間を加える。
 * もしもどれかの勤務時間と連続してる一連の時間だったならmerge。
 */
function pushWorktime(shifts, sh, sm, fh, fm){
    var start = {"hour": sh, "min": sm};
    var finish = {"hour": fh, "min": fm};
    var _shifts = [];
    var merged = false;
    for (var shift of shifts){
        if (timeEquals(shift["finish"], start)){
             _shifts.push({"start": shift["start"], "finish": finish})
            merged = true;
        } else if (timeEquals(shift["start"], finish)){
            _shifts.push({"start": start, "finish": shift["finish"]})
            merged = true;
        } else {
            _shifts.push(shift);
        }
    }
    if (!merged){
        _shifts.push({"start": start, "finish": finish})
    }
    return _shifts;
}

/*
 * 2つの時間HH/MMが一致するかを返すだけの関数。
 */
function timeEquals(time1, time2){
    return time1["hour"] === time2["hour"] && time1["min"] === time2["min"];
}

/*
 * テキストエリアの内容を解釈してJSON化・table化する。
 */
function extractData(){
    ////////この関数のみの変数(var宣言をつける。本当は変数名がかぶらないならいらない。)で、for-loopの外に置いときたい組////////

    var rowValue = $('#shift_textarea').value;
    var lines = rowValue.split('\n');

    var theDay = "";
    var theWorktime = [] // 勤務時間を格納するArray(数がわからず複数個ありうるのでArray)
    var theWorkingTree = {"modified": makeDateString(today, '{0}/{1}/{2}')}; // 半期のデータ記録を格納するObject

    var isFirstHalf = null;
    var theMonth = null;
    var theYear = null;

    ///////////lineごとの処理///////////
    for (var line of lines) {
        var dayMatch = line.match(/\d+\/\d+(?=\([月火水木金土日]\))/g); 
        // Array<String> matches
        // ["8/14"] or null

        if (dayMatch != null && dayMatch.length == 1){
            // この行が8/14(金)[確定]とか書いてある行

            if (theWorktime.length > 0){
                // すでに今までに11:30-22:15とかがあった
                theWorkingTree[theDay] = theWorktime;
                // ツリーに保存 (まだtheDayは前のループ時のtheDay)
                theWorktime = [];
                // 一時データは消去
            }
            theDay = addYearToDay(dayMatch[0]); // "2017/8/14"
            // theDayを更新(次への布石)

            if (isFirstHalf == null){
                var _d = new Date(theDay);
                isFirstHalf = _d.getDate() <= 15;
                theMonth = _d.getMonth() + 1;
                theYear = _d.getFullYear();
            }
        }

        timeMatch = line.match(/(\d+):(\d+)-(\d+):(\d+)/);
        // Array<String> matches
        // ["11:30-12:30", "11", "30", "12", "30"]

        if (timeMatch != null){
            //この行が11:30-20:15とか書いてある行
            theWorktime = pushWorktime(theWorktime, parseInt(timeMatch[1]), parseInt(timeMatch[2]), parseInt(timeMatch[3]), parseInt(timeMatch[4]));
        }
    }
    ///////////end: lineごとの処理///////////
    // ループ後の未完の処理
    if (theWorktime.length > 0){
        theWorkingTree[theDay] = theWorktime;
        theWorktime = [];
    }
    /////////////////line処理完了//////////////////

    if (theYear == null){
        // inputされたデータががおかしかった
        return;
    }

    var _postfix = isFirstHalf ? "0" : "1"; // 前半なら0, 後半なら1
    var _title = theYear + "." +theMonth + "." + _postfix;  //2017.8.0 = 2017年8月前半
    theYggdrasil[_title] = theWorkingTree;

    saveData();

    // textareaの内容をリセット
    $('#shift_textarea').value = '';
}

/*
 * jsonの読み取り専用textareaの値を更新し、テーブルの内容を更新し、localStorageにデータを保存する3つの作業をまとめた関数。
 */
function saveData() {
    // JSONを整理して表示
    if ($('#json_checkbox').checked){
        $('#json_textarea').value = JSON.stringify(theYggdrasil, null, "    ");
    } else {
        $('#json_textarea').value = JSON.stringify(theYggdrasil);
    }
    buildTableContent();
    localStorage.setItem("data", JSON.stringify(theYggdrasil));
}

function buildTableContent() {
    var theNearestDate = null; // 次の勤務dayのdateobj
    var theNearestWorkTime = []; //次の勤務デイの勤務時間Array

    var keys = Object.keys(theYggdrasil);
    // 並び替え (2017.8.0と2016.9.1など...)
    keys.sort(function(a,b){
        var _as = a.split("."); 
        var _bs = b.split("."); 
        if (parseInt(_as[0]) > parseInt(_bs[0])) return 1; 
        if (parseInt(_as[0]) < parseInt(_bs[0])) return -1; 
        if (parseInt(_as[1]) > parseInt(_bs[1])) return 1;
        if (parseInt(_as[1]) < parseInt(_bs[1])) return -1;
        if (parseInt(_as[2]) > parseInt(_bs[2])) return 1;
        if (parseInt(_as[2]) < parseInt(_bs[2])) return -1;
        return 0;
    });
    ////end: 並び替え////

    var tableHtml = '<table class="table table-striped"><tr><th>#</th><th>期間</th><th>実働時間</th><th>作成日時</th></tr>';

    // 半月毎の処理
    // keysはtheYggdrasilのkey配列を並び替えたもの
    for (var keyTerm of keys) {
        if (!theYggdrasil.hasOwnProperty(keyTerm)) {
            continue;
        }

        // 半月の勤務時間データ
        var _WorkingTree = theYggdrasil[keyTerm];

        // 拘束時間の合計
        var wholeBondedMin = 0;
        // 休憩時間の合計
        var wholeRestMin = 0;
        // 作成日時
        var modifiedDay = "";

        /*
         * _WorkingTree(半期の勤務obj)の構造は
         * 
         * {
         *   - "modified" : "2017/7/30"
         *   - "2017/8/1" : [勤務時間Obj1, 勤務時間Obj2...]
         *   - "2017/8/3" : [勤務時間Obj1, 勤務時間Obj2...]
         *   ...
         * }
         */
        for (var keyDay in _WorkingTree){
            if (!_WorkingTree.hasOwnProperty(keyDay)){
                continue;
            }

            // keyDayは"2017/8/1"系か"modified" (modifiedは一回だけ)
            if (keyDay === "modified"){
                modifiedDay = _WorkingTree[keyDay]; // "2017/7/30"とかが格納される
            } else {
                var shifts = _WorkingTree[keyDay]; // Array<Object> [勤務時間Obj1, 勤務時間Obj2...]

                var dateObj = new Date(keyDay); // Date("2017/8/1")
                var _dtime = dateObj.getTime() - today.getTime(); // 今(ただしhtml読み込み時点の時間)との時間差ms
                if (_dtime > 0 && (theNearestDate == null || _dtime < Math.abs(theNearestDate.getTime() - today.getTime()))){
                    // 今より勤務日程があとで、より現時点との時間的距離が近い。比較対象がない(=null)ならもうそれを採用だ。
                    theNearestDate = dateObj;
                    theNearestWorkTime = shifts;
                }

                for (var shift of shifts){
                    // 拘束時間
                    var bonded = getBondedMinute(shift);
                    wholeBondedMin += bonded;
                    wholeRestMin += getRestMin(bonded);
                }
            }
        }
        tableHtml += makeTrHtml(keyTerm, wholeBondedMin - wholeRestMin, modifiedDay);
    }

    tableHtml += '</table>'
    if (theNearestDate != null) {
        tableHtml = '<div><h4>次の出勤日:</h4><p>{0} {1}</p></div>'.format(makeDateString(theNearestDate, '{1}/{2} ({3})'), makeWorktimeString(theNearestWorkTime)) + tableHtml;
    }
    $("#shift_table").innerHTML = tableHtml;
}

/*
 * 勤務時間objのArrayから"11:30-20:00"といったstringをつくる関数。
 */
function makeWorktimeString(shifts) {
    var r = '';
    var c = 0;
    for (var shift of shifts){
        if (c > 0) r+= ', '
        var _st = shift["start"];
        var _fn = shift["finish"];
        var _sth = _st["hour"];
        var _stm = _st["min"];
        var _fnh = _fn["hour"];
        var _fnm = _fn["min"];
        if (_stm  < 10) _stm = '0' + _stm;
        if (_fnm < 10) _fnm = '0' + _fnm;
        r += '{0}:{1}-{2}:{3}'.format(_sth,_stm,_fnh,_fnm);
        c++;
    }
    return r;
}

/*
 * いろんな形式のdateから好きな形の日付Stringに変換する関数
 */
function makeDateString(input, formatting){
    const days = ["日","月","火","水","木","金","土"]
    var dateObj;
    if (typeof input === 'number'){
        dateObj = new Date(input);
    } else if (input instanceof Date){
        dateObj = input;
    } else if (typeof input === 'string'){
        dateObj = new Date(input);
    }
    var year = dateObj.getFullYear();
    var month = dateObj.getMonth() + 1;
    var date = dateObj.getDate();
    var day = days[dateObj.getDay()];
    return formatting.format(year, month, date, day);
}

/*
 * 一覧tableのtrをつくる関数。
 * 
 * # |  期間   | 実働時間 |  作成日時
 * --+--------+---------+-----------
 * × | 8月前半 |  40.25  | 2017/7/30
 */
function makeTrHtml(keyTerm, actualTime, modifiedDay) {
    var _t  = '<tr>'
    _t += '<td><img src="src/delete.svg" title="このデータを削除" class="delete" onclick="deleteTerm(\'{0}\')"></td>'.format(keyTerm);
    _t += '<td title="詳しいデータを見る" class="hoverer" onclick="showTerm(\'{0}\')">{1}</td>'.format(keyTerm, parseKeyTerm(keyTerm));
    _t += '<td>{0}</td>'.format(actualTime/60);
    _t += '<td>{0}</td>'.format(modifiedDay);
    _t += '</tr>';
    return _t;
}

/*
 * "2017.8.0"とかの形式的な記述から"8月前半"という人が読みやすい文字列を返す関数。
 */
function parseKeyTerm(keyTerm) {
    var _ks = keyTerm.split(".");
    var _post = _ks[2] == "0" ? "前半" : "後半";
    return '{0}月{1}'.format(_ks[1], _post);
}

/*
 * 半月分のデータを消す関数。バツマークをクリックしたときに呼ばれる。
 */
function deleteTerm(keyTerm){
    if ($('#delete_checkbox').checked || window.confirm("本当に"+parseKeyTerm(keyTerm)+"のデータを削除しますか?")){
        delete theYggdrasil[keyTerm];
        saveData();
    }
}

/*
 * tableのタイトルの部分("8月前半"など)をクリックしたときに発火する関数
 * theYggdrasilから指定の半月分のデータを抜き出し表示。
 * buildTableContent()でも同じような処理があるが、ループ内の処理に若干の差異があるため統合はしない。
 */
function showTerm(keyTerm) {
    // 対象となる半月の勤務時間データ
    var _WorkingTree = theYggdrasil[keyTerm];
    var html = '<button type="button" class="close" aria-label="Close" id="hideTerm" onclick="hideTerm()"><span aria-hidden="true">&times;</span></button>'
    //日付ごとに処理
    /*
     * _WorkingTreeの構造は、8月上半期なら
     * 
     * {
     *   - "modified" : "2017/7/30"
     *   - "2017/8/1" : [勤務時間Obj1, 勤務時間Obj2...]
     *   - "2017/8/3" : [勤務時間Obj1, 勤務時間Obj2...]
     *   ...
     * }
     */
    var keys = Object.keys(_WorkingTree);
    keys.sort(function(a,b){
        var _as = a.split("/"); 
        var _bs = b.split("/");
        if (_as.length === 1) return 1;
        if (_bs.length === 1) return -1;
        if (parseInt(_as[2]) > parseInt(_bs[2])) return 1;
        if (parseInt(_as[2]) < parseInt(_bs[2])) return -1;
        return 0;
    });
    for (var keyDay of keys){
        if (_WorkingTree.hasOwnProperty(keyDay)){
            // 今回は作成日時はいらない
            if (keyDay != "modified"){
                // その日の勤務時間Array
                var shifts = _WorkingTree[keyDay];
                // その日の合計拘束時間
                var alldaybonded = 0;
                // その日の合計休憩時間
                var alldayrest = 0;
                // 勤務時間ブロックごとの処理
                for (var shift of shifts){
                    var bonded = getBondedMinute(shift);
                    alldaybonded += bonded;
                    alldayrest += getRestMin(bonded);
                }
                html += '<div class="block" onclick="edit(\'{3}\',\'{4}\')"><p><strong>{0}</strong></p><p>勤務時間: {1}</p><p>実働時間: {2}h</p></div>'.format(makeDateString(keyDay, '{0}/{1}/{2} ({3})'), makeWorktimeString(shifts), (alldaybonded-alldayrest)/60, keyDay, keyTerm);
            }
        }
    }
    $("#showTerm").innerHTML += html;
    $("#termBack").style.display = 'block';
    showingTerm = true;
}

function edit(keyDay, keyTerm){
    var _WorkingTree = theYggdrasil[keyTerm];
    var shifts = _WorkingTree[keyDay];

    var html = '<h3>{0}の勤務時間の編集</h3>'.format(keyDay);

    var hasel,hafsel,masel,mafsel;

    for (var x = 0; x < shifts.length; x++) {
        shift = shifts[x]
        html += '<div style="margin-bottom:1em;">'
        var hsel = '<select class="form-control" id="hsel">';
        var hfsel = '<select class="form-control" id="hfsel">';
        hasel = '<select class="form-control" id="hasel">';
        hafsel = '<select class="form-control" id="hafsel">';
        for (var i = 0; i < 24; i++){
            var str = '<option>{0}</option>'.format(i);
            var strSel = '<option selected>{0}</option>'.format(i);
            if (shift["start"]["hour"] === i){
                hsel += strSel;
            } else {
                hsel += str;
            }
            if (shift["finish"]["hour"] === i){
                hfsel += strSel;
            } else {
                hfsel += str;
            }
            hasel += str;
            hafsel += str;
        }
        hsel += '</select>';
        hfsel += '</select>';
        hasel += '</select>';
        hafsel += '</select>';

        var msel = '<select class="form-control" id="msel">';
        var mfsel = '<select class="form-control" id="mfsel">';
        masel = '<select class="form-control" id="masel">';
        mafsel = '<select class="form-control" id="mafsel">';
        for (var i = 0; i < 60; i += 15){
            var j = i === 0 ? '00' : i+'';
            var str = '<option>{0}</option>'.format(j);
            var strSel = '<option selected>{0}</option>'.format(j);
            if (shift["start"]["min"] === i){
                msel += strSel;
            } else {
                msel += str;
            }
            if (shift["finish"]["min"] === i){
                mfsel += strSel;
            } else {
                mfsel += str;
            }
            masel += str;
            mafsel += str;
        }
        msel += '</select>';
        mfsel += '</select>';
        masel += '</select>';
        mafsel += '</select>';

        html += hhmmformformat.format(hsel, msel, hfsel, mfsel);
        html += '<button class="btn btn-primary" type="submit" onclick="saveEdit(\'{0}\',\'{1}\', {2})">Save</button>'.format(keyDay, keyTerm, x);
        html += '&nbsp;<button class="btn btn-danger" type="submit" onclick="removeEdit(\'{0}\',\'{1}\',{2})">Remove</button>'.format(keyDay, keyTerm, x);
        html += '&nbsp;<button class="btn btn-default" type="submit" onclick="hideEdit()">Cancel</button>';
        html += '</div>';
    }
    html += '&nbsp;<button class="btn btn-success" type="submit" onclick="toggleEdit(\'{0}\')">Add</button>'.format(keyDay);
    html += '<div style="display:none" id="tog{0}" class="addEdit"><h4>勤務時間を追加</h4>'.format(keyDay);
    html += hhmmformformat.format(hasel, masel, hafsel, mafsel);
    html += '<button class="btn btn-primary" type="submit" onclick="addEdit(\'{0}\',\'{1}\')">勤務時間を追加</button>'.format(keyDay, keyTerm);
    html += '</div>';
    $("#editWorktime").innerHTML = html;
    $("#editBack").style.display = 'block';
    showingEdit = true;
}

function addWorktime(){
    var year = $("#yearaw").selectedIndex + today.getFullYear() - 1;
    var month = $("#monthaw").selectedIndex + 1;
    var date = $("#dateaw").selectedIndex + 1;

    if (monthday(year, month) < date){
        printError('日付が存在しない日付です!');
        return;
    }

    var sh = $("#asel").selectedIndex;
    var sm = 15 * $("#aselz").selectedIndex;
    var fh = $("#afsel").selectedIndex;
    var fm = 15 * $("#afselz").selectedIndex;

    var _postfix = date <= 15 ? '0' : '1';
    var keyTerm = '{0}.{1}.{2}'.format(year, month, _postfix);
    var keyDay = '{0}/{1}/{2}'.format(year, month, date);

    var shiftStr = '';
    if (theYggdrasil.hasOwnProperty(keyTerm)){
        if (theYggdrasil[keyTerm].hasOwnProperty(keyDay)){
            shiftStr = makeWorktimeString(theYggdrasil[keyTerm][keyDay]);
            theYggdrasil[keyTerm][keyDay] = pushWorktime(theYggdrasil[keyTerm][keyDay], sh, sm, fh, fm);
        } else {
            theYggdrasil[keyTerm][keyDay] = pushWorktime([], sh, sm, fh, fm);
        }
    } else {
        var _wobj = {}
        _wobj[keyDay] = pushWorktime([], sh, sm, fh, fm);
        theYggdrasil[keyTerm] = _wobj;
    }
    theYggdrasil[keyTerm]["modified"] = makeDateString(today, '{0}/{1}/{2}');
    saveData();

    var shiftStr2 = makeWorktimeString(theYggdrasil[keyTerm][keyDay]);

    printSuccess('勤務時間を追加しました。 {0}: {1} -> {2}'.format(keyDay, shiftStr, shiftStr2));
    //initAddWorktime();
}

function initAddWorktime(){
    var year = today.getFullYear();
    var month = today.getMonth() + 1;
    var date = today.getDate();

    var year_sel = '<select class="form-control" id="yearaw">';
    year_sel += '<option>{0}</option>'.format(year - 1);
    year_sel += '<option selected>{0}</option>'.format(year);
    year_sel += '<option>{0}</option>'.format(year + 1);
    year_sel += '</select>';

    var month_sel = '<select class="form-control" id="monthaw">';
    for (var i = 1;i < 13;i++){
        if (i === month){
            month_sel += '<option selected>{0}</option>'.format(i);
        } else {
            month_sel += '<option>{0}</option>'.format(i);
        }
    }
    month_sel += '</select>';

    var date_sel = '<select class="form-control" id="dateaw">';
    for (var i = 1;i < 32; i++){
        if (i === date){
            date_sel += '<option selected>{0}</option>'.format(i);
        } else {
            date_sel += '<option>{0}</option>'.format(i);
        }
    }
    date_sel += '</select>';

    var asel = '<select class="form-control" id="asel">';
    var afsel = '<select class="form-control" id="afsel">';
    for (var i = 0; i < 24; i++){
        if (i === 12){
            asel += '<option selected>{0}</option>'.format(i);
            afsel += '<option selected>{0}</option>'.format(i);
        } else {
            asel += '<option>{0}</option>'.format(i);
            afsel += '<option>{0}</option>'.format(i);
        }
    }
    asel += '</select>';
    afsel += '</select>';

    var aselz = '<select class="form-control" id="aselz">';
    var afselz = '<select class="form-control" id="afselz">';
    for (var i = 0; i < 60; i += 15){
        var j = i === 0 ? '00' : i+'';
        if (i === 0){
            aselz += '<option selected>{0}</option>'.format(j);
            afselz += '<option selected>{0}</option>'.format(j);
        } else {
            aselz += '<option>{0}</option>'.format(j);
            afselz += '<option>{0}</option>'.format(j);
        }
    }
    aselz += '</select>';
    afselz += '</select>';

    var html = '<h3>勤務時間の追加</h3><div class="input-group a">{0}<div class="input-group-addon">年</div>{1}<div class="input-group-addon">月</div>{2}<div class="input-group-addon">日</div></div>'.format(year_sel, month_sel, date_sel);
    html += hhmmformformat.format(asel, aselz, afsel, afselz);
    html += '<button class="btn btn-primary" type="submit" onclick="addWorktime()">Add</button> <button class="btn btn-default" type="submit" onclick="initAddWorktime()">Reset</button>';

    $("#addWorktime").innerHTML = html;
}

function monthday(year, month){
    var lastday = new Array('', 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31);
    if ((year % 4 == 0 && year % 100 != 0) || year % 400 == 0){
        lastday[2] = 29;
    }
    return lastday[month];
}

function addEdit(keyDay, keyTerm){
    var sh = $("#hasel").selectedIndex;
    var sm = 15 * $("#masel").selectedIndex;
    var fh = $("#hafsel").selectedIndex;
    var fm = 15 * $("#mafsel").selectedIndex;

    var shiftStr = makeWorktimeString(theYggdrasil[keyTerm][keyDay]);

    theYggdrasil[keyTerm][keyDay] = pushWorktime(theYggdrasil[keyTerm][keyDay], sh, sm, fh, fm);

    theYggdrasil[keyTerm]["modified"] = makeDateString(today, '{0}/{1}/{2}');

    hideEdit();
    $("#showTerm").innerHTML = '';
    saveData();
    showTerm(keyTerm);

    var shiftStr2 = makeWorktimeString(theYggdrasil[keyTerm][keyDay]);

    printSuccess('勤務時間を追加しました。 {0}: {1} -> {2}'.format(keyDay, shiftStr, shiftStr2));
}

function toggleEdit(keyDay){
    var str = $("#tog{0}".format(keyDay)).style.display;
    if (str === 'none'){
        $("#tog{0}".format(keyDay)).style.display = 'block';
    } else {
        $("#tog{0}".format(keyDay)).style.display = 'none';
    }
}

function hideEdit(){
    $("#editWorktime").innerHTML = '';
    $("#editBack").style.display = 'none';
    showingEdit = false;
}

function saveEdit(keyDay, keyTerm, x){
    if (showingEdit){
        var sh = $("#hsel").selectedIndex;
        var sm = 15 * $("#msel").selectedIndex;
        var fh = $("#hfsel").selectedIndex;
        var fm = 15 * $("#mfsel").selectedIndex;

        var shiftStr = makeWorktimeString([theYggdrasil[keyTerm][keyDay][x]]);

        var newArray = [];
        for (var i = theYggdrasil[keyTerm][keyDay].length - 1; i >= 0; i--) {
            if (i != x){
                newArray.push(theYggdrasil[keyTerm][keyDay][i]);
            }
        }

        theYggdrasil[keyTerm][keyDay] = pushWorktime(newArray, sh, sm, fh, fm);

        hideEdit();
        $("#showTerm").innerHTML = '';
        saveData();
        showTerm(keyTerm);
        sm = sm == 0 ? '00' : sm + ''; 
        fm = fm == 0 ? '00' : fm + ''; 
        printSuccess('変更内容を保存しました。 {0}: {1} -> {2}'.format(keyDay, shiftStr, '{0}:{1}-{2}:{3}'.format(sh, sm, fh, fm)));
    }
}

function printSuccess(massage){
    $("#success").innerHTML = massage + '<button type="button" class="close" aria-label="Close" onclick="vanishSuccess()"><span aria-hidden="true">&times;</span></button>';
    $("#success").style.display = 'block';
}

function vanishSuccess(){
    $("#success").style.display = 'none';
    $("#success").innerHTML = '';
}

function printError(massage){
    $("#error").innerHTML = massage + '<button type="button" class="close" aria-label="Close" onclick="vanishError()"><span aria-hidden="true">&times;</span></button>';
    $("#error").style.display = 'block';
}

function vanishError(){
    $("#error").style.display = 'none';
    $("#error").innerHTML = '';
}

function removeEdit(keyDay, keyTerm, x){
    var shiftStr = makeWorktimeString([theYggdrasil[keyTerm][keyDay][x]]);
    if ($("#delete_day_checkbox").checked || window.confirm('本当に{0} {1}を削除しますか?'.format(keyDay, shiftStr))){
        if (theYggdrasil[keyTerm][keyDay].length === 1){
            delete theYggdrasil[keyTerm][keyDay];
            if (Object.keys(theYggdrasil[keyTerm]).length == 1){
                // modified のみになった場合
                delete theYggdrasil[keyTerm];
            }
        } else {
            var newArray = [];
            for (var i = theYggdrasil[keyTerm][keyDay].length - 1; i >= 0; i--) {
                if (i != x){
                    newArray.push(theYggdrasil[keyTerm][keyDay][i]);
                }
            }
            theYggdrasil[keyTerm][keyDay] = newArray;
        }
    }
    hideEdit();
    $("#showTerm").innerHTML = '';
    saveData();
    showTerm(keyTerm);
}

/*
 * 半月の勤務時間一覧を消す関数。
 */
function hideTerm(){
    $("#showTerm").innerHTML = '';
    $("#termBack").style.display = 'none';
    showingTerm = false;
}

/*
 * min以上max未満であればtrue
 */
function isin(num, min, max){
    return num >= min && num < max;
}

/*
 * 拘束時間から休憩時間を求める関数。
 *  4.5 -  6.0 -> 0.50
 *  6.0 -  7.0 -> 0.75
 *  7.0 - 12.0 -> 1.00
 * 12.0 -      -> 2.00
 */
function getRestMin(bondedMin) {
    var restMin = 0;
    if (isin(bondedMin, 270, 360)){ //4.5h - 6h
        restMin = 30;
    } else if (isin(bondedMin, 360, 420)){ //6h - 7h
        restMin = 45;
    } else if (isin(bondedMin, 420, 720)){ //7h - 12h
        restMin = 60;
    } else if (bondedMin >= 720){ //12h -
        restMin = 120;
    }
    return restMin;
}

/*
 * worktimeObjの構造は、8:30-16:45なら
 *
 * {
 *  - "start"  - "hour" : 8
 *             - "min"  : 30
 *  - "finish" - "hour" : 16
 *             - "min"  : 45
 * }
 *
 * これから拘束時間を求める関数。
 */
function getBondedMinute(worktimeObj){
    var _st = worktimeObj["start"];
    var _fn = worktimeObj["finish"];

    var startH = _st["hour"];
    var startM = _st["min"];
    var finishH = _fn["hour"];
    var finishM = _fn["min"];

    if (finishH < startH || (finishH == startH && finishM < startM)){
        finishH += 24;
    }

    return (finishH - startH) * 60 + (finishM - startM);
}
/*
 * Day(MM/DD)に適当な西暦をつけ加えたYYYY/MM/DDみたいにする関数。
 * MM/DDなら2016/4/1と2017/4/1が区別できなくて、上書きされてしまうので。
 * textareaからデータを引き出すときに使われる。
 */
function addYearToDay(theDay) {
    var _day = theDay.split('/');
    var _theMonth = parseInt(_day[0]);
    var theDate = parseInt(_day[1]);

    // 年明け前に正月のシフト考えるような年明けを挟むときの処理
    year = today.getFullYear();
    // このHTMLを開いている付きが11,12月で、textareaからのデータの月が1,2月。
    // jsonやloclaStorageから読み込むときにこの処理は行われない。
    if (today.getMonth() >= 10 && _theMonth <= 2){
        year ++;
    }

    return year + "/" + theDay;
}

/*
 * jQueryの$()とおんなじ
 * CSS-likeに#idとか.class、tagnameで、　HTML-DOM-Element or Array<HTML-DOM-Element>を返す関数。
 */
function $(elemId) {
    if (elemId.startsWith('#')){
        return document.getElementById(elemId.split('#')[1]);
    } else if (elemId.startsWith('.')){
        return document.getElementsByClassName(elemId.split('.')[1]);
    } else {
        return document.getElementsByTagName(elemId);
    }
}

/*
 * 自前のformat関数。文字列内の{i}を順番に引数と入れ替えていく。
 */
String.prototype.format = function (arg) {
    var text = this;
    for (var i=0; i < arguments.length; i++) {
        text = text.replace("{" + i + "}", arguments[i]);
    }
    return text;
}

// bodyのロード時に関数を実行。 document.body === $('body')[0] -> true (===は型まで同じでtrueを返す言語構造)
document.body.onload = bodyLoadEvent();
</script>
</html>